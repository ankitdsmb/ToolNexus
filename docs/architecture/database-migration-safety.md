# Database migration safety for PostgreSQL identity columns

## Why this fails

PostgreSQL identity columns (`GENERATED BY DEFAULT AS IDENTITY`) cannot be freely mutated by all `ALTER COLUMN` forms that EF-generated SQL may emit for drifted schemas. In particular, startup migrations can fail when a migration attempts to re-apply identity metadata for a column that is already identity.

## Safe migration strategy

ToolNexus migrations use provider-guarded helper methods in `MigrationSafetyExtensions` to make schema transitions idempotent:

- `SafeAlterIdentityIfNeeded` checks `information_schema.columns.is_identity` and only applies identity conversion when the column is not already identity.
- `SafeDropConstraintIfExists` protects startup when constraints are already dropped by drift.
- `SafeIndexCreateIfMissing` enables index creation without duplicate-object failures.

## Idempotent principles

- Check before mutating (`IF EXISTS` / metadata introspection).
- Keep PostgreSQL-specific SQL guarded by provider checks.
- Ensure migration replay is safe for blank, drifted, and already-migrated databases.
- Preserve the existing ToolNexus startup and execution lifecycle; only harden migration behavior and diagnostics.
