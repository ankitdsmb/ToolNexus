@{
    ViewData["Title"] = "Operator Command Center";
}

<div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="mb-0">Operator Command Center</h2>
    <button class="btn btn-sm btn-primary" id="refresh-monitoring">Refresh</button>
</div>

<div class="row g-2 mb-2" id="global-runtime-status">
    <div class="col-md-3"><div class="card"><div class="card-body py-2"><small>Environment</small><div id="env-status">production</div></div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body py-2"><small>Health</small><div id="pending-count">-</div></div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body py-2"><small>Alerts</small><div id="dead-letter-count">-</div></div></div></div>
    <div class="col-md-3"><div class="card"><div class="card-body py-2"><small>Queue</small><div id="retry-count">-</div></div></div></div>
</div>

<div class="card mb-2" id="stream-panel"><div class="card-body py-2">
    <h4 class="card-title">Live Execution Stream</h4>
    <div class="table-responsive"><table class="table table-sm"><thead><tr><th>When</th><th>Tool</th><th>Authority</th><th>Adapter</th><th>Runtime</th><th>Governance</th><th>Duration</th><th>Status</th></tr></thead><tbody id="stream-body"></tbody></table></div>
</div></div>

<div class="card mb-2" id="controls-panel"><div class="card-body py-2">
    <h4 class="card-title">Operator Action Zone</h4>
    <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-sm btn-outline-warning" data-command="cache-reset" data-risk="medium">Reset Cache</button>
        <button class="btn btn-sm btn-outline-warning" data-command="queue-drain" data-risk="high">Drain Queue</button>
        <button class="btn btn-sm btn-outline-warning" data-command="queue-replay" data-risk="medium">Reprocess Failed Jobs</button>
    </div>
    <small class="text-secondary">All commands require reason, explicit confirmation, and audit emission.</small>
</div></div>

<div class="row g-2 mb-2" id="domain-grid">
    <div class="col-md-4"><div class="card"><div class="card-body py-2"><h5>Governance</h5><div id="governance-summary">-</div></div></div></div>
    <div class="col-md-4"><div class="card"><div class="card-body py-2"><h5>Capability Lifecycle</h5><div id="capability-summary">-</div><a href="/admin/capabilities/marketplace" class="btn btn-sm btn-outline-secondary mt-1">Open Editor</a></div></div></div>
    <div class="col-md-4"><div class="card"><div class="card-body py-2"><h5>Quality Intelligence</h5><div id="quality-summary">-</div></div></div></div>
</div>

<div class="card" id="incidents-panel"><div class="card-body py-2">
    <h4 class="card-title">Incident + Diagnostics</h4>
    <div class="table-responsive"><table class="table table-sm"><thead><tr><th>Last Occurrence (UTC)</th><th>Severity/Type</th><th>Tool</th><th>Error Message</th><th class="text-end">Count</th></tr></thead><tbody id="incidents-body"></tbody></table></div>
</div></div>

<script>
(async function(){
  const page=1,pageSize=15;
  const statusClass=s=>s==='success'?'bg-green-lt':(s==='blocked'?'bg-red-lt':(s==='failed'?'bg-orange-lt':'bg-yellow-lt'));
  const sevClass=s=>s==='critical'?'bg-red-lt':(s==='warning'?'bg-yellow-lt':'bg-secondary-lt');

  async function loadHealth(){const r=await fetch('/admin/execution/health'); if(!r.ok)return; const h=await r.json();
    document.getElementById('pending-count').textContent=`pending ${h.pendingItems}`; document.getElementById('retry-count').textContent=`retry ${h.retryCount}`; document.getElementById('dead-letter-count').textContent=`dead ${h.deadLetterCount}`;
  }
  async function loadStream(){const r=await fetch('/admin/execution/stream?take=25'); if(!r.ok)return; const items=await r.json(); document.getElementById('stream-body').innerHTML='';
    (items||[]).forEach(x=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.executedAtUtc}</td><td>${x.toolId}</td><td>${x.authority}</td><td>${x.adapter}</td><td>${x.runtimeIdentity}</td><td>${x.governanceResult}</td><td>${x.durationMs}ms</td><td><span class="badge ${statusClass(x.status)}">${x.status}</span></td>`; document.getElementById('stream-body').appendChild(tr);});
  }
  async function loadGovernance(){const r=await fetch('/admin/execution/governance'); if(!r.ok)return; const g=await r.json(); document.getElementById('governance-summary').textContent=`Approved ${g.approvedDecisions} · Blocked ${g.blockedExecutions} · Review ${g.requiresApproval}`;}
  async function loadCapability(){const r=await fetch('/admin/execution/capability-lifecycle'); if(!r.ok)return; const c=await r.json(); document.getElementById('capability-summary').textContent=`Draft ${c.draft} · Review ${c.review} · Approved ${c.approved} · Active ${c.active} · Deprecated ${c.deprecated}`;}
  async function loadQuality(){const r=await fetch('/admin/execution/quality'); if(!r.ok)return; const q=await r.json(); document.getElementById('quality-summary').textContent=`Score ${q.averageQualityScore} · Conformance failures ${q.conformanceFailures} · Instability ${q.runtimeInstabilitySignals} · Anomalies ${q.anomalyAlerts}`;}
  async function loadIncidents(){const r=await fetch(`/admin/execution/incidents?page=${page}&pageSize=${pageSize}`); if(!r.ok)return; const data=await r.json(); document.getElementById('incidents-body').innerHTML='';
    (data.items||[]).forEach(i=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${i.occurredAtUtc}</td><td><span class="badge ${sevClass(i.severity)}">${i.severity}/${i.eventType}</span></td><td>${i.destination}</td><td>${i.summary}</td><td class="text-end">${i.attemptCount}</td>`; document.getElementById('incidents-body').appendChild(tr);});
  }

  async function runCommand(command){
    const reason=prompt(`Confirm ${command}. Enter reason:`); if(!reason) return;
    const risk=document.querySelector(`[data-command="${command}"]`)?.dataset.risk ?? 'medium';
    const confirmation=prompt(`Risk level ${risk.toUpperCase()}. Type CONFIRM to execute ${command}.`); if(confirmation!=='CONFIRM') return;
    await fetch(`/admin/execution/operations/${command}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({reason,impactScope:'global-runtime',authorityContext:'operator',rollbackPlan:'Use queue replay or manual restore'})});
    await refresh();
  }

  async function refresh(){await Promise.all([loadHealth(),loadStream(),loadGovernance(),loadCapability(),loadQuality(),loadIncidents()]);}
  document.querySelectorAll('[data-command]').forEach(b=>b.addEventListener('click',()=>runCommand(b.dataset.command)));
  document.getElementById('refresh-monitoring').addEventListener('click',refresh);
  setInterval(()=>{loadHealth();loadStream();},5000);
  await refresh();
})();
</script>
