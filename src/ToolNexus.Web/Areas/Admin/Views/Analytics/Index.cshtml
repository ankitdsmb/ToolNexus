@{
    ViewData["Title"] = "Analytics";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Admin Analytics</h2>
    <a class="btn btn-sm btn-outline-secondary" asp-area="Admin" asp-controller="Dashboard" asp-action="Index">Back to dashboard</a>
</div>

<div class="card mb-4">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label" for="filter-tool">Tool slug</label>
                <input id="filter-tool" class="form-control" placeholder="all tools" />
            </div>
            <div class="col-md-3">
                <label class="form-label" for="filter-start">Start date</label>
                <input id="filter-start" type="date" class="form-control" />
            </div>
            <div class="col-md-3">
                <label class="form-label" for="filter-end">End date</label>
                <input id="filter-end" type="date" class="form-control" />
            </div>
            <div class="col-md-3 d-flex gap-2">
                <button id="apply-filters" class="btn btn-primary">Apply filters</button>
                <button id="clear-filters" class="btn btn-outline-secondary">Reset</button>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4" id="summary-cards">
    <div class="col-md-3"><button class="card w-100 text-start border-0 analytics-nav-card" data-drill="top-tools"><div class="card-body"><small class="text-secondary">Executions Today</small><h3 id="metric-total">-</h3></div></button></div>
    <div class="col-md-3"><button class="card w-100 text-start border-0 analytics-nav-card" data-drill="success"><div class="card-body"><small class="text-secondary">Success Rate</small><h3 id="metric-success">-</h3></div></button></div>
    <div class="col-md-3"><button class="card w-100 text-start border-0 analytics-nav-card" data-drill="slow-tools"><div class="card-body"><small class="text-secondary">Avg Duration</small><h3 id="metric-duration">-</h3></div></button></div>
    <div class="col-md-3"><button class="card w-100 text-start border-0 analytics-nav-card" data-drill="drilldown"><div class="card-body"><small class="text-secondary">Active Tools</small><h3 id="metric-active">-</h3></div></button></div>
</div>

<div class="row g-3">
    <div class="col-lg-6">
        <div class="card mb-3" id="panel-top-tools">
            <div class="card-body">
                <h4 class="card-title">Top Tools</h4>
                <div class="table-responsive"><table class="table table-sm" id="top-tools-table"><thead><tr><th>Tool</th><th class="text-end">Executions</th><th class="text-end">Success</th><th class="text-end">Avg ms</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card mb-3" id="panel-slow-tools">
            <div class="card-body">
                <h4 class="card-title">Slow Tools</h4>
                <div class="table-responsive"><table class="table table-sm" id="slow-tools-table"><thead><tr><th>Tool</th><th class="text-end">Executions</th><th class="text-end">Success</th><th class="text-end">Avg ms</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-3" id="panel-drilldown">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="card-title mb-0">Daily Drilldown</h4>
            <small class="text-secondary" id="drilldown-count">-</small>
        </div>
        <div class="table-responsive">
            <table class="table table-sm" id="drilldown-table">
                <thead><tr><th>Date</th><th>Tool</th><th class="text-end">Executions</th><th class="text-end">Failures</th><th class="text-end">Success</th><th class="text-end">Avg ms</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-sm btn-outline-secondary" id="drilldown-prev">Prev</button>
            <span class="align-self-center text-secondary" id="drilldown-page-label">Page 1</span>
            <button class="btn btn-sm btn-outline-secondary" id="drilldown-next">Next</button>
        </div>
    </div>
</div>

<script>
(async function(){
    let currentPage = 1;
    let totalItems = 0;
    const pageSize = 20;

    const params = new URLSearchParams(window.location.search);
    const now = new Date();
    const endDefault = now.toISOString().slice(0, 10);
    const startDate = new Date(now);
    startDate.setDate(now.getDate() - 13);
    const startDefault = startDate.toISOString().slice(0, 10);

    const filterTool = document.getElementById('filter-tool');
    const filterStart = document.getElementById('filter-start');
    const filterEnd = document.getElementById('filter-end');

    filterTool.value = params.get('toolSlug') || '';
    filterStart.value = params.get('startDate') || startDefault;
    filterEnd.value = params.get('endDate') || endDefault;

    const renderRows = (selector, rows) => {
        const body = document.querySelector(selector + ' tbody');
        body.innerHTML = '';
        rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><a href="?toolSlug=${encodeURIComponent(row.toolSlug)}&startDate=${filterStart.value}&endDate=${filterEnd.value}">${row.toolSlug}</a></td><td class="text-end">${row.totalExecutions}</td><td class="text-end">${row.successRate.toFixed(1)}%</td><td class="text-end">${row.avgDurationMs.toFixed(1)}</td>`;
            body.appendChild(tr);
        });
    };

    async function loadDashboard(){
        const response = await fetch('/api/admin/analytics/dashboard');
        if (!response.ok) return;
        const dashboard = await response.json();

        document.getElementById('metric-total').textContent = dashboard.totalExecutionsToday.toLocaleString();
        document.getElementById('metric-success').textContent = `${dashboard.successRate.toFixed(1)}%`;
        document.getElementById('metric-duration').textContent = `${dashboard.avgDurationMs.toFixed(1)} ms`;
        document.getElementById('metric-active').textContent = dashboard.activeToolsCount.toString();

        renderRows('#top-tools-table', dashboard.topTools || []);
        renderRows('#slow-tools-table', dashboard.slowTools || []);
    }

    async function loadDrilldown(){
        const search = new URLSearchParams({
            startDate: filterStart.value,
            endDate: filterEnd.value,
            page: String(currentPage),
            pageSize: String(pageSize)
        });

        if (filterTool.value.trim()) search.set('toolSlug', filterTool.value.trim());

        history.replaceState({}, '', `${window.location.pathname}?${search.toString()}`);

        const response = await fetch(`/api/admin/analytics/drilldown?${search.toString()}`);
        if (!response.ok) return;
        const payload = await response.json();
        const body = document.querySelector('#drilldown-table tbody');
        body.innerHTML = '';

        (payload.items || []).forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.date}</td><td>${item.toolSlug}</td><td class="text-end">${item.totalExecutions}</td><td class="text-end">${item.failureCount}</td><td class="text-end">${item.successRate.toFixed(1)}%</td><td class="text-end">${item.avgDurationMs.toFixed(1)}</td>`;
            body.appendChild(tr);
        });

        totalItems = payload.totalItems || 0;
        document.getElementById('drilldown-count').textContent = `${totalItems} rows`;
        document.getElementById('drilldown-page-label').textContent = `Page ${currentPage}`;
        document.getElementById('drilldown-prev').disabled = currentPage <= 1;
        document.getElementById('drilldown-next').disabled = currentPage * pageSize >= totalItems;
    }

    document.getElementById('apply-filters').addEventListener('click', async () => { currentPage = 1; await loadDrilldown(); });
    document.getElementById('clear-filters').addEventListener('click', async () => {
        filterTool.value = '';
        filterStart.value = startDefault;
        filterEnd.value = endDefault;
        currentPage = 1;
        await loadDrilldown();
    });

    document.getElementById('drilldown-prev').addEventListener('click', async () => { if (currentPage > 1) { currentPage -= 1; await loadDrilldown(); } });
    document.getElementById('drilldown-next').addEventListener('click', async () => { if (currentPage * pageSize < totalItems) { currentPage += 1; await loadDrilldown(); } });

    document.querySelectorAll('.analytics-nav-card').forEach(card => {
        card.addEventListener('click', () => {
            const target = card.dataset.drill;
            const panel = document.getElementById(`panel-${target}`) || document.getElementById('panel-drilldown');
            panel?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    });

    const jump = params.get('drilldown');
    if (jump) {
        requestAnimationFrame(() => {
            const panel = document.getElementById(`panel-${jump}`) || document.getElementById('panel-drilldown');
            panel?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    }

    await loadDashboard();
    await loadDrilldown();
})();
</script>
