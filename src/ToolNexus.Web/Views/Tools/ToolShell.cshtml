@model ToolPageViewModel
@{
    ViewData["Title"] = Model.Seo.Title;
    ViewData["Description"] = Model.Seo.Description;
    ViewData["CanonicalUrl"] = Model.Seo.CanonicalUrl;
    ViewData["JsonLd"] = Model.Seo.JsonLd;
    ViewData["Keywords"] = Model.Seo.Keywords;

    var contextPlugins = new[]
    {
        "Overview",
        "Features",
        "QuickStart",
        "Guidance",
        "Examples",
        "UseCases",
        "Faq",
        "RelatedTools"
    };

    var configuration = Context.RequestServices.GetRequiredService<Microsoft.Extensions.Configuration.IConfiguration>();
    var runtimeLogCaptureEnabled = configuration.GetValue<bool>("LoggingOptions:EnableRuntimeLogCapture", true);
    var runtimeLogEndpoint = runtimeLogCaptureEnabled
        ? configuration["LoggingOptions:RuntimeLogEndpoint"]
        : null;
}

@section Head {
    @if (!string.IsNullOrWhiteSpace(Model.RuntimeCssPath))
    {
        <link rel="stylesheet" href="@Model.RuntimeCssPath" asp-append-version="true" />
    }
}

<article class="tool-shell-page workspace-shell page-shell" aria-label="Tool runtime page">
    <header class="tool-shell-page__hero workspace-shell__hero tool-panel" aria-label="Tool introduction">
        <p class="tool-section__eyebrow">Runtime workspace</p>
        <div class="tool-shell-page__hero-main">
            <h1>@Model.Tool.Title</h1>
            <p>@(Model.Content?.Intro ?? Model.Tool.SeoDescription)</p>
        </div>
        <div class="tool-shell-page__hero-meta" aria-label="Tool metadata">
            <span class="chip">@Model.Tool.Category</span>
            <span class="chip">@Model.Tool.Actions.Count action@(Model.Tool.Actions.Count == 1 ? string.Empty : "s")</span>
            <span class="chip">@(Model.Tool.IsDeterministic ? "Deterministic" : "Adaptive")</span>
        </div>
    </header>

    <section class="tool-shell-page__workspace workspace-shell__runtime-zone" aria-label="Runtime workspace" data-workspace-zone="runtime">
        <header class="tool-shell-page__workspace-head" aria-label="Runtime hints">
            <p class="tool-shell-page__workspace-label">INPUT (control) → RUNTIME → OUTPUT (evidence)</p>
            <p class="tool-shell-page__workspace-hint">Left panel defines request intent; right panel preserves execution evidence, metadata, and diagnostics.</p>
        </header>
        <section id="tool-root" class="tool-shell-page__runtime" data-tool-shell="true" data-tool-root="true" data-tool-slug="@Model.Tool.Slug" aria-label="Interactive runtime">
            <header data-tool-context="true" data-tool-header="true" class="tn-tool-header" aria-label="Tool execution context">
                <h2>@Model.Tool.Title runtime</h2>
            </header>
            <section data-tool-input="true" class="tn-tool-panel" aria-label="Tool input panel">
                <p>Input area loading…</p>
            </section>
            <section class="tn-tool-panel" aria-label="Tool output workspace">
                <div data-tool-status="true" class="tool-execution-status" role="status" aria-live="polite">Idle · Ready for request</div>
                <section data-tool-output="true" aria-label="Tool output panel">
                    <p>Output preview loading…</p>
                </section>
            </section>
            <footer data-tool-followup="true" data-tool-actions="true" class="tool-execution-panel" aria-label="Follow-up actions">
                <button type="button" disabled>Preparing runtime</button>
            </footer>
        </section>
    </section>

    <aside class="tool-seo tool-shell-page__docs workspace-shell__context-rail" data-nosnippet="false" data-workspace-zone="context" aria-label="Tool documentation">
        @foreach (var plugin in contextPlugins)
        {
            @await Html.PartialAsync($"~/Views/Tools/Plugins/_{plugin}Plugin.cshtml", Model)
        }
    </aside>
    @* SSR section contract anchors:
       <h2>Overview</h2>
       <h2>Features</h2>
       <h2>Quick start</h2>
       <h2>Examples</h2>
       <h2>Use cases</h2>
       <h2>FAQ</h2>
       <h2>Related tools</h2>
    *@
</article>

@section Scripts {
    <script>
        window.ToolNexusConfig = {
            apiBaseUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ApiBaseUrl)),
            toolExecutionPathPrefix: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ToolExecutionPathPrefix)),
            runtimeModulePath: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RuntimeModulePath)),
            manifestEndpoint: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ManifestEndpoint)),
            tool: {
                slug: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.Slug)),
                title: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.Title)),
                seoDescription: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.SeoDescription)),
                exampleInput: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.ExampleInput)),
                clientSafeActions: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.ClientSafeActions)),
                actions: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.Actions)),
                operationSchema: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.OperationSchema))
            },
            runtimeUiMode: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RuntimeUiMode)),
            runtimeComplexityTier: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RuntimeComplexityTier)),
            runtimeEnvironment: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Context.RequestServices.GetRequiredService<Microsoft.AspNetCore.Hosting.IWebHostEnvironment>().EnvironmentName)),
            isAdmin: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.IsAdminPreview)),
            runtimeLogEndpoint: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(runtimeLogEndpoint)),
            runtimeRoutes: {
                clientLogEndpoints: [@Html.Raw(System.Text.Json.JsonSerializer.Serialize(runtimeLogEndpoint))]
            }
        };
        window.ToolNexusLogging = {
            minimumLevel: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(configuration["LoggingOptions:RuntimeLogLevel"] ?? configuration["LoggingOptions:MinimumLevel"] ?? "Information")),
            runtimeDebugEnabled: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(configuration.GetValue<bool>("LoggingOptions:RuntimeDebugEnabled"))),
            enableRuntimeLogCapture: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(runtimeLogCaptureEnabled))
        };
        window.ToolNexus = window.ToolNexus || {};
        window.ToolNexus.correlationId = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Context.TraceIdentifier));
    </script>
    <script type="module" src="~/js/tool-runtime.js" asp-append-version="true"></script>
    <script type="module" src="~/js/tool-shell-feel.js" asp-append-version="true"></script>
}
