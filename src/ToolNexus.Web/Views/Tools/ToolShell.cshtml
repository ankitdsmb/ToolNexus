@model ToolPageViewModel
@{
    ViewData["Title"] = Model.Seo.Title;
    ViewData["Description"] = Model.Seo.Description;
    ViewData["CanonicalUrl"] = Model.Seo.CanonicalUrl;
    ViewData["JsonLd"] = Model.Seo.JsonLd;
    ViewData["Keywords"] = Model.Seo.Keywords;

    var contextPlugins = new[]
    {
        "Overview",
        "Features",
        "QuickStart",
        "Guidance",
        "Examples",
        "UseCases",
        "Faq",
        "RelatedTools"
    };
}

@section Head {
    @if (!string.IsNullOrWhiteSpace(Model.RuntimeCssPath))
    {
        <link rel="stylesheet" href="@Model.RuntimeCssPath" asp-append-version="true" />
    }
}

<article class="tool-shell-page workspace-shell tool-page page-shell" aria-label="Tool runtime page">
    <header class="tool-shell-page__hero workspace-shell__hero tool-panel" aria-label="Tool introduction">
        <p class="tool-section__eyebrow">Runtime workspace</p>
        <div class="tool-shell-page__hero-main">
            <h1>@Model.Tool.Title</h1>
            <p>@(Model.Content?.Intro ?? Model.Tool.SeoDescription)</p>
        </div>
        <div class="tool-shell-page__hero-meta" aria-label="Tool metadata">
            <span class="chip">@Model.Tool.Category</span>
            <span class="chip">@Model.Tool.Actions.Count action@(Model.Tool.Actions.Count == 1 ? string.Empty : "s")</span>
            <span class="chip">@(Model.Tool.IsDeterministic ? "Deterministic" : "Adaptive")</span>
        </div>
    </header>

    <section class="tool-shell-page__workspace workspace-shell__runtime-zone" aria-label="Runtime workspace" data-workspace-zone="runtime">
        <header class="tool-shell-page__workspace-head" aria-label="Runtime hints">
            <p class="tool-shell-page__workspace-label">INPUT → RUN → COPY</p>
            <p class="tool-shell-page__workspace-hint">Execute in runtime first. Pull context only when blocked.</p>
        </header>
        <div class="tool-shell-page__runtime-zone-shell" data-runtime-zone-shell="true" data-runtime-container="true">
            <div id="tool-root" class="tool-shell-page__runtime" data-tool-root="true" data-tool-slug="@Model.Tool.Slug" aria-label="Interactive runtime">
                <header data-tool-header="true" class="tn-tool-header">
                    <h2>@Model.Tool.Title runtime</h2>
                </header>
                <section data-tool-body="true" class="tn-tool-body">
                    <section data-tool-input="true" class="tn-tool-panel" aria-label="Tool input panel">
                        <p>Input area loading…</p>
                    </section>
                    <section data-tool-output="true" class="tn-tool-panel" aria-label="Tool output panel">
                        <p>Output preview loading…</p>
                    </section>
                    <div data-tool-actions="true" class="tool-execution-panel">
                        <button type="button" disabled>Preparing runtime</button>
                    </div>
                </section>
            </div>
        </div>
        <aside class="tool-shell-page__momentum" aria-live="polite" hidden data-momentum-loop="true">
            <p class="tool-shell-page__momentum-title">Next step ready</p>
            <p class="tool-shell-page__momentum-copy">Output ready. Copy now or chain into the next tool.</p>
        </aside>
    </section>

    <aside class="tool-seo tool-shell-page__docs workspace-shell__context-rail" data-nosnippet="false" data-workspace-zone="context" aria-label="Tool documentation">
        @foreach (var plugin in contextPlugins)
        {
            @await Html.PartialAsync($"~/Views/Tools/Plugins/_{plugin}Plugin.cshtml", Model)
        }
    </aside>
    @* SSR section contract anchors:
       <h2>Overview</h2>
       <h2>Features</h2>
       <h2>Quick start</h2>
       <h2>Examples</h2>
       <h2>Use cases</h2>
       <h2>FAQ</h2>
       <h2>Related tools</h2>
    *@
</article>

@section Scripts {
    <script>
        window.ToolNexusConfig = {
            apiBaseUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ApiBaseUrl)),
            toolExecutionPathPrefix: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ToolExecutionPathPrefix)),
            runtimeModulePath: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RuntimeModulePath)),
            tool: {
                slug: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.Slug)),
                title: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.Title)),
                seoDescription: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.SeoDescription)),
                exampleInput: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.ExampleInput)),
                clientSafeActions: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.ClientSafeActions))
            },
            runtimeLogEndpoint: "/api/admin/runtime/logs"
        };
        window.ToolNexusLogging = {
            minimumLevel: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Context.RequestServices.GetRequiredService<Microsoft.Extensions.Configuration.IConfiguration>()["LoggingOptions:MinimumLevel"] ?? "Information")),
            runtimeDebugEnabled: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Context.RequestServices.GetRequiredService<Microsoft.Extensions.Configuration.IConfiguration>().GetValue<bool>("LoggingOptions:RuntimeDebugEnabled"))),
            enableRuntimeLogCapture: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Context.RequestServices.GetRequiredService<Microsoft.Extensions.Configuration.IConfiguration>().GetValue<bool>("LoggingOptions:EnableRuntimeLogCapture", true)))
        };
        window.ToolNexus = window.ToolNexus || {};
        window.ToolNexus.correlationId = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Context.TraceIdentifier));
    </script>
    <script type="module" src="~/js/tool-runtime.js" asp-append-version="true"></script>
    <script type="module" src="~/js/tool-shell-feel.js" asp-append-version="true"></script>
}
