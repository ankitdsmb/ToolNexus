@model ToolPageViewModel
@{
    ViewData["Title"] = Model.Seo.Title;
    ViewData["Description"] = Model.Seo.Description;
    ViewData["CanonicalUrl"] = Model.Seo.CanonicalUrl;
    ViewData["JsonLd"] = Model.Seo.JsonLd;
    ViewData["Keywords"] = Model.Seo.Keywords;

    var contextPlugins = new[]
    {
        "Overview",
        "Features",
        "QuickStart",
        "Guidance",
        "Examples",
        "UseCases",
        "Faq",
        "RelatedTools"
    };

    var contextPluginLabels = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
    {
        ["Overview"] = "Overview",
        ["Features"] = "Features",
        ["QuickStart"] = "Quick Start",
        ["Guidance"] = "Guidance",
        ["Examples"] = "Examples",
        ["UseCases"] = "Use Cases",
        ["Faq"] = "FAQ",
        ["RelatedTools"] = "Related Tools"
    };

    var configuration = Context.RequestServices.GetRequiredService<Microsoft.Extensions.Configuration.IConfiguration>();
    var runtimeLogCaptureEnabled = configuration.GetValue<bool>("LoggingOptions:EnableRuntimeLogCapture", true);
    var runtimeLogEndpoint = runtimeLogCaptureEnabled
        ? configuration["LoggingOptions:RuntimeLogEndpoint"]
        : null;
}

@section Head {
    <link rel="stylesheet" href="~/css/tool-auto-professional.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/system/tool-execution-auto.css" asp-append-version="true" />
    @if (!string.IsNullOrWhiteSpace(Model.RuntimeCssPath))
    {
        <link rel="stylesheet" href="@Model.RuntimeCssPath" asp-append-version="true" />
    }
}

<article class="tool-shell-page tool-shell-page--workspace workspace-shell page-shell" aria-label="Tool runtime page">
    <h1>@Model.Tool.Title</h1>
    <section class="tool-shell-page__workspace workspace-shell__runtime-zone" aria-label="Runtime workspace" data-workspace-zone="runtime">
        @* Architecture lock: ToolShell owns execution framing only.
           Tool widgets render their own internal layout inside the full content host.
           Canonical anchor contract must remain stable for runtime guards and telemetry. *@
        <section id="tool-root" class="tool-shell-page__runtime" data-tool-shell="true" data-tool-root="true" data-tool-slug="@Model.Tool.Slug" aria-label="Interactive runtime">
            <header data-tool-context="true" data-tool-header="true" class="tn-tool-header" aria-label="Tool execution context">
                <span class="tool-context-pill tool-context-pill--authority">Authority: UnifiedAuthoritative</span>
                <span class="tool-context-pill">Runtime .NET Core</span>
                <span class="tool-context-pill">Policy: Conformance v1</span>
                <span class="tool-context-pill">Lifecycle: Ready</span>
            </header>
            <div data-tool-status="true" data-runtime-status-primary="true" class="tool-execution-status runtime-metrics-row" role="status" aria-live="polite">Idle Â· Ready for request</div>
            <footer data-tool-followup="true" data-tool-actions="true" class="tool-execution-panel" aria-label="Follow-up actions">
                <button type="button" disabled>Preparing runtime</button>
            </footer>
            @* ToolShell framing only: no shell-defined editor/result grid ownership.
               Template/lifecycle runtime mounts directly into this full-width host. *@
            <section data-tool-content-host="true" class="tool-runtime-content-host" aria-label="Tool content host">
                @* Canonical extension anchors are preserved; tool widget owns content within them. *@
                <section data-tool-input="true" aria-label="Tool input extension slot"></section>
                <section data-tool-output="true" aria-label="Tool output extension slot"></section>
            </section>
        </section>
    </section>

    <aside class="tool-seo tool-shell-page__docs workspace-shell__context-rail tool-article-prose" data-nosnippet="false" data-workspace-zone="context" aria-label="Tool documentation">
        @foreach (var plugin in contextPlugins)
        {
            var isPrimaryDocSection = plugin.Equals("Overview", StringComparison.OrdinalIgnoreCase)
                || plugin.Equals("QuickStart", StringComparison.OrdinalIgnoreCase);
            <section class="tool-md-section" data-doc-section="@plugin" data-doc-priority="@(isPrimaryDocSection ? "primary" : "secondary")">
                @if (isPrimaryDocSection)
                {
                    <h3>@contextPluginLabels[plugin]</h3>
                    <div class="tool-md-content">
                        @await Html.PartialAsync($"~/Views/Tools/Plugins/_{plugin}Plugin.cshtml", Model)
                    </div>
                }
                else
                {
                    <details class="runtime-doc-disclosure">
                        <summary>@contextPluginLabels[plugin]</summary>
                        <div class="runtime-doc-disclosure__body tool-md-content">
                            @await Html.PartialAsync($"~/Views/Tools/Plugins/_{plugin}Plugin.cshtml", Model)
                        </div>
                    </details>
                }
            </section>
        }
    </aside>
    @* SSR section contract anchors:
       <h2>Overview</h2>
       <h2>Features</h2>
       <h2>Quick start</h2>
       <h2>Examples</h2>
       <h2>Use cases</h2>
       <h2>FAQ</h2>
       <h2>Related tools</h2>
    *@
</article>

@section Scripts {
    <script>
        window.ToolNexusConfig = {
            apiBaseUrl: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ApiBaseUrl)),
            toolExecutionPathPrefix: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ToolExecutionPathPrefix)),
            runtimeModulePath: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RuntimeModulePath)),
            manifestEndpoint: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ManifestEndpoint)),
            tool: {
                slug: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.Slug)),
                title: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.Title)),
                seoDescription: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.SeoDescription)),
                exampleInput: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.ExampleInput)),
                clientSafeActions: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.ClientSafeActions)),
                actions: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.Actions)),
                operationSchema: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tool.OperationSchema))
            },
            runtimeUiMode: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RuntimeUiMode)),
            runtimeComplexityTier: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RuntimeComplexityTier)),
            runtimeEnvironment: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Context.RequestServices.GetRequiredService<Microsoft.AspNetCore.Hosting.IWebHostEnvironment>().EnvironmentName)),
            runtimeTemplateMountMode: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(configuration["RuntimeOptions:TemplateMountMode"] ?? "content-host")),
            isAdmin: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.IsAdminPreview)),
            runtimeLogEndpoint: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(runtimeLogEndpoint)),
            runtimeRoutes: {
                clientLogEndpoints: [@Html.Raw(System.Text.Json.JsonSerializer.Serialize(runtimeLogEndpoint))]
            }
        };
        window.ToolNexusLogging = {
            minimumLevel: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(configuration["LoggingOptions:RuntimeLogLevel"] ?? configuration["LoggingOptions:MinimumLevel"] ?? "Information")),
            runtimeDebugEnabled: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(configuration.GetValue<bool>("LoggingOptions:RuntimeDebugEnabled"))),
            enableRuntimeLogCapture: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(runtimeLogCaptureEnabled))
        };
        window.ToolNexus = window.ToolNexus || {};
        window.ToolNexus.correlationId = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Context.TraceIdentifier));
    </script>
    <script type="module" src="~/js/tool-runtime.js" asp-append-version="true"></script>
    <script type="module" src="~/js/tool-shell-feel.js" asp-append-version="true"></script>
}
