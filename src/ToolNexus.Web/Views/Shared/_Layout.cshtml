@using System.Text.Json
@using ToolNexus.Application.Services
@using ToolNexus.Web.Models.Layout
@using ToolNexus.Web.Services
@inject IToolCatalogService ToolCatalogService
@inject IAppVersionService AppVersion
@{
    var title = ViewData["Title"]?.ToString() ?? "ToolNexus";
    var description = ViewData["Description"]?.ToString() ?? "ToolNexus online developer tools.";
    var canonicalUrl = ViewData["CanonicalUrl"]?.ToString()
        ?? $"{Context.Request.Scheme}://{Context.Request.Host}{Context.Request.Path}{Context.Request.QueryString}";
    var keywords = ViewData["Keywords"]?.ToString() ?? "developer tools, online utilities, ToolNexus";
    var robots = ViewData["Robots"]?.ToString() ?? "index,follow";
    var jsonLd = ViewData["JsonLd"]?.ToString();
    var siteUrl = $"{Context.Request.Scheme}://{Context.Request.Host}";
    var socialImageUrl = ViewData["SocialImageUrl"]?.ToString() ?? $"{siteUrl}/assets/toolnexus-og.svg";
    var currentPath = ViewContext.HttpContext.Request.Path.Value?.ToLowerInvariant() ?? string.Empty;

    bool IsActive(string path)
    {
        var normalizedPath = path.ToLowerInvariant();
        return normalizedPath == "/"
            ? string.Equals(currentPath, "/", StringComparison.Ordinal)
            : currentPath.StartsWith(normalizedPath, StringComparison.Ordinal);
    }

    var headerModel = new LayoutHeaderViewModel
    {
        Links =
        [
            new NavLinkViewModel { Text = "Home", Href = "/", IsActive = IsActive("/") },
            new NavLinkViewModel { Text = "Tools", Href = "/tools", IsActive = IsActive("/tools") },
            new NavLinkViewModel { Text = "About", Href = "/about", IsActive = IsActive("/about") },
            new NavLinkViewModel { Text = "Disclaimer", Href = "/disclaimer", IsActive = IsActive("/disclaimer") },
            new NavLinkViewModel { Text = "Contact Us", Href = "/contact-us", IsActive = IsActive("/contact-us") }
        ]
    };

    var footerModel = new LayoutFooterViewModel
    {
        VersionDisplay = AppVersion.VersionDisplay,
        BuildNumber = AppVersion.BuildNumber
    };

    var defaultJsonLd = JsonSerializer.Serialize(new
    {
        @context = "https://schema.org",
        @graph = new object[]
        {
            new
            {
                @type = "Organization",
                name = "ToolNexus",
                url = siteUrl,
                logo = $"{siteUrl}/assets/toolnexus-og.svg"
            },
            new
            {
                @type = "WebSite",
                name = "ToolNexus",
                url = siteUrl,
                description = "Developer-first utility platform for faster shipping."
            }
        }
    });

    var commandPaletteTools = ToolCatalogService.GetAllTools()
        .Select(tool => new
        {
            slug = tool.Slug,
            title = tool.Title,
            category = tool.Category,
            description = tool.SeoDescription
        });
}
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@title</title>

    <meta name="description" content="@description" />
    <meta name="keywords" content="@keywords" />
    <meta name="robots" content="@robots" />
    <meta name="theme-color" content="#0b1020" />
    <link rel="canonical" href="@canonicalUrl" />
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com" />
    <link rel="preload" href="~/css/site.css" as="style" asp-append-version="true" />
    <link rel="modulepreload" href="~/js/ui-state-manager.js" asp-append-version="true" />
    <link rel="modulepreload" href="~/js/dynamic-widget-engine.js" asp-append-version="true" />
    <link rel="modulepreload" href="~/js/command-palette.js" asp-append-version="true" />

    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="ToolNexus" />
    <meta property="og:title" content="@title" />
    <meta property="og:description" content="@description" />
    <meta property="og:url" content="@canonicalUrl" />
    <meta property="og:image" content="@socialImageUrl" />
    <meta property="og:image:alt" content="ToolNexus developer utility platform" />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:image" content="@socialImageUrl" />
    <meta name="twitter:title" content="@title" />
    <meta name="twitter:description" content="@description" />

    @if (!string.IsNullOrWhiteSpace(jsonLd))
    {
        <script type="application/ld+json">@Html.Raw(jsonLd)</script>
    }

    <script type="application/ld+json">@Html.Raw(defaultJsonLd)</script>

    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    @await RenderSectionAsync("Head", required: false)
</head>
<body class="page-enter">
<div class="app-shell">
    <partial name="_Header" model="headerModel" />

    <div class="banner" role="note">
        Do not paste secrets or sensitive credentials.
    </div>

    <main class="container" role="main">
        @RenderBody()
    </main>

    <partial name="_Footer" model="footerModel" />
</div>

<script id="toolCatalogData" type="application/json">@Html.Raw(JsonSerializer.Serialize(commandPaletteTools))</script>

<div id="commandPalette" class="command-palette tn-modal" data-modal-root data-modal-id="commandPalette" hidden>
    <button class="tn-modal__backdrop command-palette__overlay" type="button" data-modal-backdrop aria-label="Close command palette"></button>

    <section class="tn-modal__dialog command-palette__dialog" data-modal-dialog role="dialog" aria-modal="true" aria-labelledby="commandPaletteTitle">
        <header class="command-palette__header">
            <p id="commandPaletteTitle" class="command-palette__title">Command Palette</p>
            <div class="command-palette__header-actions">
                <span class="command-palette__shortcut">⌘K to open · Esc to close</span>
                <button class="tn-modal__close" type="button" data-command-close aria-label="Close command palette">✕</button>
            </div>
        </header>

        <label class="u-sr-only" for="commandPaletteInput">Search tools and commands</label>
        <input id="commandPaletteInput" class="command-palette__input" type="text" autocomplete="off" placeholder="Search tools, actions, recents..." />

        <p class="command-palette__assistive" id="commandPaletteHint">Use arrow keys to navigate and Enter to run a command.</p>
        <ul id="commandPaletteList" class="command-palette__list" role="listbox" aria-describedby="commandPaletteHint"></ul>
    </section>
</div>

<div id="shortcutHintModal" class="tn-modal shortcut-hint-modal" data-modal-root data-modal-id="shortcutHint" data-modal-remove-on-close="true" hidden>
    <button class="tn-modal__backdrop" type="button" data-modal-backdrop aria-label="Close shortcut hint"></button>
    <section class="tn-modal__dialog shortcut-hint-modal__dialog" data-modal-dialog role="dialog" aria-modal="true" aria-labelledby="shortcutHintTitle">
        <header class="shortcut-hint-modal__header">
            <h2 id="shortcutHintTitle">Keyboard shortcut unlocked</h2>
            <button type="button" class="tn-modal__close" data-shortcut-hint-close aria-label="Close shortcut hint">✕</button>
        </header>
        <p><strong>Tip:</strong> Press <kbd>⌘K</kbd> to open tools instantly, then type to jump.</p>
        <button class="shortcut-hint-modal__cta" type="button" data-shortcut-hint-close>Got it</button>
    </section>
</div>

<div id="shortcutHelpOverlay" class="shortcut-help tn-modal" data-modal-root data-modal-id="shortcutHelp" hidden>
    <button class="tn-modal__backdrop shortcut-help__overlay" type="button" data-modal-backdrop aria-label="Close shortcut help"></button>
    <section class="tn-modal__dialog shortcut-help__dialog" data-modal-dialog role="dialog" aria-modal="true" aria-labelledby="shortcutHelpTitle" tabindex="-1">
        <header class="shortcut-help__header">
            <h2 id="shortcutHelpTitle">Keyboard shortcuts</h2>
            <button type="button" class="tn-modal__close" data-shortcut-help-close aria-label="Close shortcut help">✕</button>
        </header>
        <ul>
            <li><kbd>⌘K</kbd><span>Open command palette</span></li>
            <li><kbd>⌘⇧D</kbd><span>Toggle theme</span></li>
            <li><kbd>⌘⇧R</kbd><span>Open most recent tool</span></li>
            <li><kbd>⌘/</kbd><span>Open shortcut help</span></li>
        </ul>
    </section>
</div>

<script type="module" src="~/js/ui-state-manager.js" asp-append-version="true"></script>
<script type="module" src="~/js/theme-manager.js" asp-append-version="true"></script>
<script type="module" src="~/js/version-manager.js" asp-append-version="true"></script>
<script type="module" src="~/js/dynamic-widget-engine.js" asp-append-version="true"></script>
<script type="module" src="~/js/command-palette.js" asp-append-version="true"></script>
<script type="module" src="~/js/motion-system.js" asp-append-version="true"></script>

@await RenderSectionAsync("Scripts", required: false)

</body>
</html>
